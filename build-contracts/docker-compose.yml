version: "3.4"
services:

  zookeeper:
    image: solsson/kafka:2.1.1@sha256:8bc8242c649c395ab79d76cc83b1052e63b4efea7f83547bf11eb3ef5ea6f8e1
    entrypoint: ./bin/zookeeper-server-start.sh
    command:
    - ./config/zookeeper.properties

  kafka:
    image: solsson/kafka:2.1.1@sha256:8bc8242c649c395ab79d76cc83b1052e63b4efea7f83547bf11eb3ef5ea6f8e1
    links:
    - zookeeper
    entrypoint:
    - ./bin/kafka-server-start.sh
    - ./config/server.properties
    - --override
    -   zookeeper.connect=zookeeper:2181
    - --override
    -   log.retention.hours=-1
    - --override
    -   log.dirs=/var/lib/kafka/data/topics
    - --override
    # Shouldn't be needed for streams, but currently for the test container(s) to produce data
    -   auto.create.topics.enable=true
    - --override
    -   default.replication.factor=1
    - --override
    -   min.insync.replicas=1
    - --override
    -   offsets.retention.minutes=10080
    # For access from dev environment
    - --override
    -   listeners=OUTSIDE://:19092,PLAINTEXT://:9092
    - --override
    -   advertised.listeners=OUTSIDE://localhost:19092,PLAINTEXT://:9092
    - --override
    -   listener.security.protocol.map=PLAINTEXT:PLAINTEXT,OUTSIDE:PLAINTEXT
    - --override
    -   inter.broker.listener.name=PLAINTEXT
    ports:
    - 19092:19092

  pixy:
    depends_on:
    - kafka
    build: ./pixy
    ports:
    - 19090:19090
    command:
    - -tcpAddr
    -  0.0.0.0:19090

  topic1-create:
    image: solsson/kafkacat@sha256:b91241b5741fccaef282eb8dbdfb6e5289bb8586274175b1836e57912ffecaef
    entrypoint:
    - /bin/bash
    - -c
    command:
    - |
      until kafkacat -b kafka:9092 -C -K '=' -t topic1 -e; do sleep 3; done

  smoketest:
    depends_on:
    - pixy
    image: solsson/curl@sha256:92ebf15ac57bea360484480336ed5d9fa16d38d773fd00f7e9fb2cae94baf25a
    labels:
    - com.yolean.build-contract
    entrypoint:
    - /bin/bash
    - -cex
    - |
      curl --ipv4 --retry 5 --retry-connrefused http://pixy:19090 -I
